---
interface Props {
  data: Array<{ week_ending: string; total_bikes: number }>;
  title: string;
  accentColor: 'green' | 'pink';  // 'green' for national, 'pink' for county
  subtitle?: string;
}

const { data, title, accentColor, subtitle } = Astro.props;

// Generate 52 weeks of data (padding with zeros for missing weeks)
function generate52Weeks(inputData: Array<{ week_ending: string; total_bikes: number }>) {
  const today = new Date();
  const weeks: Array<{ week_ending: string; total_bikes: number }> = [];

  // Create a map of existing data by week_ending for O(1) lookup
  const dataMap = new Map(inputData.map(d => [d.week_ending, d.total_bikes]));

  // Calculate the next Sunday (end of current week)
  const nextSunday = new Date(today);
  nextSunday.setDate(nextSunday.getDate() + (7 - today.getDay())); // Go forward to next Sunday

  // Generate 52 weeks starting from 52 weeks ago up to next Sunday
  for (let i = 51; i >= 0; i--) {
    const weekDate = new Date(nextSunday);
    weekDate.setDate(weekDate.getDate() - (i * 7));
    const weekEnding = weekDate.toISOString().split('T')[0];

    weeks.push({
      week_ending: weekEnding,
      total_bikes: dataMap.get(weekEnding) || 0
    });
  }

  return weeks;
}

const chartData = generate52Weeks(data).map(d => ({
  week: new Date(d.week_ending).toLocaleDateString('en-IE', {
    month: 'short',
    day: 'numeric'
  }),
  bikes: d.total_bikes,
  fullDate: d.week_ending
}));

// Calculate max value for scaling (excluding zeros for better visualization)
const nonZeroValues = chartData.map(d => d.bikes).filter(v => v > 0);
const maxValue = nonZeroValues.length > 0 ? Math.max(...nonZeroValues) : 1;

// CSS classes based on accent color
const glowClass = accentColor === 'pink' ? 'text-glow-pink' : 'text-glow-green';
const borderClass = accentColor === 'pink' ? 'border-neon-pink' : 'border-neon-green';
---

<section class="weekly-trend-container max-w-6xl mx-auto px-4 my-8">
  <div class="bg-velvet-midnight rounded-2xl p-8 border-2" class:list={[borderClass]}>
    <!-- Header with title and subtitle inside the box -->
    <div class="mb-6">
      <h3 class={`text-2xl font-bold text-white mb-3 ${glowClass}`}>
        {title}
      </h3>
      {subtitle && (
        <p class="text-text-secondary text-lg">
          {subtitle}
        </p>
      )}
    </div>

    <!-- Divider -->
    <div class="h-px bg-gradient-to-r from-transparent via-white to-transparent opacity-20 mb-6"></div>

    <!-- Simple bar chart: SVG-based static visualization -->
    <svg
      viewBox="0 0 1200 400"
      class="w-full h-auto"
      preserveAspectRatio="none"
      style={{ minHeight: '300px' }}
    >
      {/* Grid lines */}
      {[0, 0.25, 0.5, 0.75, 1].map((ratio) => (
        <line
          x1="60"
          y1={400 - ratio * 350 + 20}
          x2="1180"
          y2={400 - ratio * 350 + 20}
          stroke="rgba(255, 255, 255, 0.1)"
          stroke-width="1"
        />
      ))}

      {/* Y-axis */}
      <line x1="50" y1="20" x2="50" y2="370" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />

      {/* X-axis */}
      <line x1="50" y1="370" x2="1180" y2="370" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />

      {/* Bars */}
      {chartData.map((d, i) => {
        const barWidth = (1130 / chartData.length) * 0.8;
        const barX = 60 + (i * 1130) / chartData.length + ((1130 / chartData.length) - barWidth) / 2;
        const barHeight = (d.bikes / maxValue) * 350;
        const barY = 370 - barHeight;
        const neonColor = accentColor === 'pink' ? '#FF10F0' : '#39FF14';

        return (
          <g>
            <rect
              x={barX}
              y={barY}
              width={barWidth}
              height={barHeight}
              fill={neonColor}
              opacity="0.8"
              style={{
                filter: accentColor === 'pink'
                  ? 'drop-shadow(0 0 8px #FF10F0)'
                  : 'drop-shadow(0 0 8px #39FF14)',
              }}
            />
          </g>
        );
      })}

      {/* Y-axis labels */}
      {[0, 0.25, 0.5, 0.75, 1].map((ratio) => {
        const value = Math.round(maxValue * ratio);
        const y = 375 - ratio * 350;
        return (
          <text
            x="45"
            y={y + 5}
            text-anchor="end"
            fill="rgba(255, 255, 255, 0.5)"
            font-size="12"
          >
            {value.toLocaleString()}
          </text>
        );
      })}
    </svg>

    <!-- Legend -->
    <div class="mt-6 text-center text-text-secondary text-sm">
      <p>Latest {chartData.length} weeks of data</p>
    </div>
  </div>
</section>

<style>
  .weekly-trend-container {
    margin: 2rem 0;
  }
</style>
