---
import MinimalLayout from "../layouts/MinimalLayout.astro";
import CountyLeaderboard from "../components/sections/CountyLeaderboard.astro";
import CountiesGrid from "../components/sections/CountiesGrid.astro";
import BusiestHour from "../components/sections/BusiestHour.astro";
import BusiestSensor from "../components/sections/BusiestSensor.astro";

// Check for busiest sensor feature flag
const showBusiestSensor = Astro.url.searchParams.get('showBusiestSensor') === 'true';

// Fetch national stats from API
const response = await fetch(`${Astro.url.origin}/api/stats/national.json`);
const result = await response.json();

const stats = result.success ? result.data : null;

// Fetch county leaderboard data (top 3 for podium)
const countiesResponse = await fetch(`${Astro.url.origin}/api/stats/counties.json?limit=3`);
const countiesResult = await countiesResponse.json();
const counties = countiesResult.success ? countiesResult.data : [];

// Fetch ALL counties data for the counties grid (high limit to ensure we get all 32 counties)
const allCountiesResponse = await fetch(`${Astro.url.origin}/api/stats/counties.json?limit=100`);
const allCountiesResult = await allCountiesResponse.json();
const allCounties = allCountiesResult.success ? allCountiesResult.data : [];

// Fetch busiest hour data
const busiestHourResponse = await fetch(`${Astro.url.origin}/api/stats/busiest-hour.json`);
const busiestHourResult = await busiestHourResponse.json();
const busiestHour = busiestHourResult.success ? busiestHourResult.data : null;

// Fetch busiest sensor data (only if flag is enabled)
let busiestSensor = null;
if (showBusiestSensor) {
  const busiestSensorResponse = await fetch(`${Astro.url.origin}/api/stats/busiest-sensor.json`);
  const busiestSensorResult = await busiestSensorResponse.json();
  busiestSensor = busiestSensorResult.success ? busiestSensorResult.data : null;
}
---

<MinimalLayout
  title="The Ride | Ireland's Cycling Data"
  description="Ireland's national cycling statistics - real-time bike counts from sensors across the country"
>
  <!-- National Dashboard Section -->
  <section class="bg-velvet-black min-h-screen py-20 px-4 md:px-6">
    <div class="container mx-auto max-w-6xl">
      <!-- Page Header -->
      <h1 class="text-3xl md:text-6xl font-medium text-white mb-6 text-center">
        Ireland <span class="greenhead text-glow-green">Rides!</span>
      </h1>
      <p class="text-text-secondary text-xl text-center mb-12">
        Not that kind of rides, you animals
      </p>

      <!-- Opening Context -->
      <div class="max-w-3xl mx-auto mb-16">
        <p class="text-text-secondary text-lg text-center leading-relaxed">
          Nobody uses bikes. Except - they do. And loads of them.
          Sensors all over Ireland are counting cyclists in real-time, proving that bikes aren't
          just for Lycra-clad lunatics on Sunday mornings. These numbers are real, the craic is real,
          and the infrastructure is... well, they're working on that bit. But look at us go anyway.
        </p>
      </div>

      <div class="neon-divider mb-16"></div>

      {stats ? (
        <div class="flex flex-col items-center mb-20">
          <h2 class="text-2xl text-text-secondary mb-4">National Ride-o-meter</h2>
          <div class="bg-velvet-midnight p-6 md:p-12 rounded-2xl neon-border-yellow neon-pulse w-full max-w-2xl">
            <div class="text-6xl md:text-9xl font-bold text-neon-yellow mb-4 text-center">
              {Math.round(stats.total_bikes).toLocaleString()}
            </div>
            <p class="text-text-secondary text-base md:text-lg text-center">
              rides yesterday
            </p>
          </div>
        </div>

        <!-- Metadata -->
        <div class="text-center mt-8">
          <p class="text-text-muted text-sm">
            Intel from {stats.sensor_count} roadside sensors • Updated: {new Date(stats.last_updated).toLocaleString('en-IE', {
              dateStyle: 'medium',
              timeStyle: 'short'
            })}
          </p>
        </div>

        <!-- Dashboard widgets section -->
        {showBusiestSensor && busiestSensor ? (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto">
            {busiestHour && (
              <BusiestHour
                hour={busiestHour.hour}
                count={busiestHour.count}
              />
            )}
            <BusiestSensor
              locationName={busiestSensor.location_name}
              county={busiestSensor.county}
              bikeCount={busiestSensor.bike_count}
              segmentId={busiestSensor.segment_id}
            />
          </div>
        ) : (
          busiestHour && (
            <BusiestHour
              hour={busiestHour.hour}
              count={busiestHour.count}
            />
          )
        )}

        <!-- The Rideyest County Section -->
        <div class="mt-20">
          <div class="neon-divider mb-12"></div>
          <div class="max-w-3xl mx-auto mb-12">
            <h2 class="text-3xl md:text-4xl font-medium text-white mb-6 text-center">
              The <span class="greenhead text-glow-green">Rideyest</span> County
            </h2>
            <p class="text-text-secondary text-lg text-center leading-relaxed">
              These aren't estimates or surveys or some gobshite with a clipboard. This is real bikes
              passing real sensors on real roads — counted every single time a wheel spins past.
              No guesswork, no waffle, just cold hard numbers from Telraam yokes watching the traffic
              like nosey neighbours. This is who's actually cycling.
            </p>
          </div>

        <!-- County Leaderboard -->
          <CountyLeaderboard counties={counties} />
        </div>

        <!-- All Counties Navigation Grid -->
        <div class="mt-20">
          <CountiesGrid counties={allCounties} />
        </div>

        <!-- Closing CTA -->
        <div class="mt-20">
          <div class="neon-divider mb-12"></div>
          <div class="max-w-3xl mx-auto text-center">
            <p class="text-text-secondary text-lg leading-relaxed">
              Missing your county? Ah now, that's not on. The only reason a place doesn't show up here
              is because there's no Telraam sensor counting yet—and that's a problem you can fix yourself.
              Stick one of these clever yokes in your window, start tallying cyclists, and give your local
              councillors something real to ignore. C'mon, don't let Dublin have all the fun.
            </p>
          </div>
        </div>

        <!-- About Link -->
        <div class="mt-12 text-center">
          <a href="/about" class="text-neon-green hover:text-glow-green transition-all duration-300 text-lg">
            Learn more about this ... thing →
          </a>
        </div>

        <!-- Knowledge Base Link - Hidden until articles are updated -->
        <!-- <a href="/knowledge" class="text-neon-yellow hover:text-glow-yellow transition-all duration-300 text-lg">
          Cycling advocacy knowledge base →
        </a> -->
      ) : (
        <!-- Error State -->
        <div class="text-center py-20">
          <p class="text-neon-orange text-xl mb-4">Unable to load national statistics</p>
          <p class="text-text-muted">Please ensure the database is running and populated with sensor data.</p>
        </div>
      )}
    </div>
  </section>
</MinimalLayout>
