---
import MinimalLayout from "../layouts/MinimalLayout.astro";
import CountyLeaderboard from "../components/sections/CountyLeaderboard.astro";
import CountiesGrid from "../components/sections/CountiesGrid.astro";
import BusiestHour from "../components/sections/BusiestHour.astro";

// Fetch national stats from API
const response = await fetch(`${Astro.url.origin}/api/stats/national.json`);
const result = await response.json();

const stats = result.success ? result.data : null;

// Fetch county leaderboard data (top 3 for podium)
const countiesResponse = await fetch(`${Astro.url.origin}/api/stats/counties.json?limit=3`);
const countiesResult = await countiesResponse.json();
const counties = countiesResult.success ? countiesResult.data : [];

// Fetch ALL counties data for the counties grid (high limit to ensure we get all 32 counties)
const allCountiesResponse = await fetch(`${Astro.url.origin}/api/stats/counties.json?limit=100`);
const allCountiesResult = await allCountiesResponse.json();
const allCounties = allCountiesResult.success ? allCountiesResult.data : [];

// Fetch busiest hour data
const busiestHourResponse = await fetch(`${Astro.url.origin}/api/stats/busiest-hour.json`);
const busiestHourResult = await busiestHourResponse.json();
const busiestHour = busiestHourResult.success ? busiestHourResult.data : null;
---

<MinimalLayout
  title="The Ride | Ireland's Cycling Data"
  description="Ireland's national cycling statistics - real-time bike counts from sensors across the country"
>
  <!-- National Dashboard Section -->
  <section class="bg-velvet-black min-h-screen py-20 px-4 md:px-6">
    <div class="container mx-auto max-w-6xl">
      <!-- Page Header -->
      <h1 class="text-3xl md:text-6xl font-medium text-white mb-6 text-center">
        Ireland <span class="greenhead text-glow-green">Rides!</span>
      </h1>
      <p class="text-text-secondary text-xl text-center mb-12">
        Not that kind of rides, you animals
      </p>
      <div class="neon-divider mb-16"></div>

      {stats ? (
        <div class="flex flex-col items-center mb-20">
          <h2 class="text-2xl text-text-secondary mb-4">National Ride-o-meter</h2>
          <div class="bg-velvet-midnight p-6 md:p-12 rounded-2xl neon-border-yellow neon-pulse w-full max-w-2xl">
            <div class="text-6xl md:text-9xl font-bold text-neon-yellow mb-4 text-center">
              {Math.round(stats.total_bikes).toLocaleString()}
            </div>
            <p class="text-text-secondary text-base md:text-lg text-center">
              rides yesterday
            </p>
          </div>
        </div>

        <!-- Metadata -->
        <div class="text-center mt-8">
          <p class="text-text-muted text-sm">
            Data from {stats.sensor_count} active sensors
          </p>
          <p class="text-text-muted text-xs mt-2">
            Last updated: {new Date(stats.last_updated).toLocaleString('en-IE', {
              dateStyle: 'medium',
              timeStyle: 'short'
            })}
          </p>
        </div>

        <!-- Busiest Hour Widget -->
        {busiestHour && (
          <BusiestHour
            hour={busiestHour.hour}
            count={busiestHour.count}
          />
        )}

        <!-- County Leaderboard -->
        <div class="mt-20">
          <div class="neon-divider mb-12"></div>
          <CountyLeaderboard counties={counties} />
        </div>

        <!-- All Counties Navigation Grid -->
        <div class="mt-20">
          <CountiesGrid counties={allCounties} />
        </div>
      ) : (
        <!-- Error State -->
        <div class="text-center py-20">
          <p class="text-neon-orange text-xl mb-4">Unable to load national statistics</p>
          <p class="text-text-muted">Please ensure the database is running and populated with sensor data.</p>
        </div>
      )}
    </div>
  </section>
</MinimalLayout>
