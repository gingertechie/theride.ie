# Weekly Trend Charts with 365-Day Data Retention

**Date:** 2026-02-07
**Feature:** Display weekly bike trip totals on national dashboard and county pages
**Goal:** Enable historical trend visualization while maintaining query performance

---

## Overview

Add weekly trend charts to show how cycling patterns have evolved over a full year. The national dashboard will display nationwide weekly totals, and each county page will show county-specific weekly trends. Data will be visualized as simple static charts using the existing Velvet & Neon design system, with copy crafted in the Irish cycling copywriter voice.

---

## Data Architecture

### Storage Strategy

- **Keep raw hourly sensor data for 365 days** (previously deleted after 7 days)
  - Enables future hourly trend visualizations and deeper analysis
  - Requires strategic indexing for performance

- **Create `sensor_weekly_stats` table** for pre-aggregated weekly totals
  - Stores aggregated weekly data for fast chart rendering
  - Schema:
    - `week_ending` (DATE) — Sunday of each week
    - `segment_id` (TEXT) — sensor identifier
    - `total_bikes` (INTEGER) — sum of bikes for that week
    - `avg_daily` (INTEGER) — average bikes per day that week
    - `created_at` (TIMESTAMP) — record creation time

- **Weekly aggregation** happens once per week (Sundays, after all weekly data collected)
  - Aggregates hourly data to county-level and national-level weekly totals
  - Maintains fast queries for dashboard charts

### Database Optimization

- Index on `(segment_id, date)` for fast hourly queries across time periods
- Index on `(county, week_ending)` for county-level weekly aggregations
- Consider table partitioning by month for large hourly dataset (optional, depending on performance testing)
- Remove current `cleanupOldData` function that deletes hourly data after 7 days
- Optional: Clean up hourly data after 365 days (based on cost/storage tolerance)

---

## API Changes

### New Endpoints

**`GET /api/stats/national/weekly.json`**
- Returns 52 weeks of national bike trip totals
- Response: Array of weekly aggregates with week_ending date and total_bikes count
- Queries pre-aggregated `sensor_weekly_stats` table (fast)
- Heavy caching: Weekly data only changes once per week

**`GET /api/stats/county/{county}/weekly.json`**
- Returns 52 weeks of county-specific bike trip totals
- Queries `sensor_weekly_stats` aggregated by county
- Same caching strategy as national endpoint

### Implementation Details

- Endpoints query the aggregated `sensor_weekly_stats` table, not raw hourly data
- Response is sorted chronologically (oldest to newest week)
- Data freshness: Updates weekly (Sunday aggregation)

---

## UI/Component Design

### National Dashboard

**New Section:** Added after the county leaderboard
**Component:** `WeeklyTrendChart.astro`

- Simple line chart visualization
- X-axis: Week (52 weeks, starting oldest)
- Y-axis: Total bike count
- Color accent: Neon green (`--neon-green: #39FF14`)
- Glow effect: Uses `--glow-green` for neon styling
- Font: Space Grotesk (existing design system)
- Responsive: Adapts to mobile/tablet/desktop

### County Pages

**New Section:** Add below county summary stats
**Component:** Same `WeeklyTrendChart.astro`, filtered to county

- Visualizes that county's weekly totals
- Color accent: Neon pink (`--neon-pink: #FF10F0`) — matches county page theme
- Glow effect: Uses `--glow-pink`
- Same responsive, static chart approach

### Chart Implementation

- Static SVG or lightweight charting library (e.g., Recharts, Chart.js, or custom SVG)
- No interactivity: Simple visual display
- Tailwind styling for responsive layout
- Matches existing Velvet & Neon aesthetic (dark backgrounds, neon accents, glow effects)

---

## Copy & Messaging

### Intro Text

**National Dashboard:**
Brief intro line above the weekly trend chart using Irish cycling copywriter voice. Should be:
- Punchy and memorable (≤10 words if possible)
- Data-grounded and irreverent
- Example tone: *"A year of pedal power: here's how the Irish are cycling, week by week."*

**County Pages:**
County-specific intro line above that county's weekly chart. Should reference the county and cycling patterns, e.g.:
- Example: *"[County]'s weekly rhythm — see where the bikes are actually flowing."*

### Copywriting Process

- Exact copy will be generated by `irish-cycling-copywriter` agent during implementation
- Copy should tell the data story without preaching
- Match tone across both national and county implementations

---

## Implementation Plan

### Phase 1: Data Infrastructure

1. Update database schema to add `sensor_weekly_stats` table
2. Create database indexes for performance
3. Create migration script to aggregate existing hourly data (if available)
4. Remove `cleanupOldData` function that deletes hourly data after 7 days
5. Update hourly data retention from 7 days to 365 days

### Phase 2: Workers & APIs

1. Create/extend weekly aggregation Cloudflare Worker
   - Runs every Sunday
   - Aggregates previous week's hourly data to `sensor_weekly_stats`
   - Updates national and county-level weekly totals
2. Create API endpoints:
   - `/api/stats/national/weekly.json`
   - `/api/stats/county/{county}/weekly.json`
3. Add aggressive caching headers (weekly data only changes weekly)

### Phase 3: Frontend Components

1. Create `WeeklyTrendChart.astro` component
   - Static chart visualization
   - Responsive design
   - Neon green/pink accent colors
   - Fetches data from new weekly APIs
2. Add component to national dashboard
3. Add component to county pages (one instance per county)

### Phase 4: Copy & UX Polish

1. Use `irish-cycling-copywriter` agent to generate intro text for both national and county sections
2. Validate copy matches brand voice
3. Add to components

### Phase 5: Testing & Optimization

1. Test chart responsiveness across devices
2. Performance test database queries with 365 days of data
3. Verify weekly aggregation worker runs correctly
4. Monitor API response times and caching effectiveness

---

## Success Criteria

- ✅ Weekly trend charts display on national dashboard
- ✅ Weekly trend charts display on all county pages
- ✅ Charts use Velvet & Neon design aesthetics
- ✅ Copy is punchy, data-grounded, and matches Irish cycling voice
- ✅ 365 days of hourly data retained in database
- ✅ API endpoints respond in <100ms (cached)
- ✅ Weekly aggregation worker runs reliably every Sunday
- ✅ Charts render correctly on mobile, tablet, desktop

---

## Open Questions

- Chart library choice: Recharts, Chart.js, custom SVG, or canvas-based?
- Data cleanup: Keep all 365 days forever, or prune after a year?
- Should county trend data be available via API for external use?

---

## Related Files

- `workers/update-sensor-data/index.ts` — Current sensor data sync worker
- `src/pages/index.astro` — National dashboard
- `src/pages/county/[slug].astro` — County pages
- `src/components/sections/CountyLeaderboard.astro` — Leaderboard component
- `db/schema.sql` — Database schema
- `prompts/agent-copywriter.md` — Irish cycling copywriter tone guide
